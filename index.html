<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>对象存储容量计算器</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;
           margin: 0; background:#f6f7f9; color:#111; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 20px; }
    .card { background:#fff; border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { font-size: 20px; margin: 0 0 10px; }
    p.sub { margin: 0 0 16px; color:#555; font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field { display:flex; flex-direction:column; gap: 6px; }
    label { font-size: 13px; color:#333; }
    select, input { font-size: 14px; padding: 10px 10px; border: 1px solid #d7dbe2; border-radius: 10px; outline: none; }
    input:focus, select:focus { border-color:#7aa7ff; box-shadow: 0 0 0 3px rgba(122,167,255,.25); }
    .result { margin-top: 14px; padding: 14px; border-radius: 12px; background:#f1f6ff; border:1px solid #d7e5ff; }
    .result h2 { font-size: 16px; margin: 0 0 6px; }
    .big { font-size: 26px; font-weight: 700; margin: 4px 0; }
    .muted { font-size: 12px; color:#555; margin: 0; line-height: 1.4; }
    .err { margin-top: 12px; padding: 12px; border-radius: 12px; background:#fff3f3; border:1px solid #ffd0d0; color:#8a1f1f; display:none; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .pill { background:#f3f4f6; border-radius: 999px; padding: 6px 10px; font-size: 12px; color:#444; }
    .hint { margin-top: 10px; }
    .footer { margin-top: 12px; }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>对象存储容量计算器（节点内 RAID + 节点间 EC / 副本）</h1>
      <p class="sub">销售打开链接即可点选参数并自动计算可用容量（TB）。免费静态网页，无需登录。</p>

      <div class="grid">
        <div class="field">
          <label>节点数量（N）</label>
          <select id="nodes"></select>
        </div>

        <div class="field">
          <label>节点内 RAID</label>
          <select id="raid">
            <option value="RAID5">RAID5</option>
            <option value="RAID6" selected>RAID6</option>
          </select>
        </div>

        <div class="field">
          <label>节点内磁盘数量（D）</label>
          <select id="disks">
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12" selected>12</option>
          </select>
        </div>

        <div class="field">
          <label>单盘容量（TB）</label>
          <input id="diskSize" type="number" min="0.1" step="0.1" value="18" />
        </div>

        <div class="field">
          <label>节点间数据保护模式</label>
          <select id="mode">
            <option value="ec" selected>纠删码（EC）</option>
            <option value="replica">副本（Replica）</option>
          </select>
        </div>

        <div class="field" id="ecField">
          <label>节点间 EC 方式</label>
          <select id="ec">
            <option value="2+1">EC 2+1</option>
            <option value="4+1">EC 4+1</option>
            <option value="6+1">EC 6+1</option>
            <option value="4+2">EC 4+2</option>
            <option value="6+2">EC 6+2</option>
            <option value="6+3" selected>EC 6+3</option>
            <option value="8+2">EC 8+2</option>
          </select>
        </div>

        <div class="field" id="replicaField" style="display:none;">
          <label>副本数量</label>
          <select id="replica">
            <option value="2" selected>2 副本</option>
            <option value="3">3 副本</option>
          </select>
        </div>
      </div>

      <div class="row" id="factorsRow"></div>
      <div class="err" id="errBox"></div>

      <div class="result" id="resultBox">
        <h2>自动计算结果</h2>
        <div class="big" id="usableTB">—</div>
        <p class="muted" id="detail"></p>
      </div>

      <p class="muted hint">
        计算口径：原始容量 = N × D × 单盘容量；最终可用容量 = 原始容量 × RAID有效系数 ×（EC有效系数 或 1/副本数）。
      </p>
      <p class="muted footer">
        说明：EC 模式适合容量效率优先；副本模式适合高可靠性优先。
      </p>
    </div>
  </div>

<script>
  // EC 最小节点数要求
  const ecMinNodes = {
    "2+1": 3,
    "4+1": 5,
    "6+1": 7,
    "4+2": 6,
    "6+2": 8,
    "6+3": 9,
    "8+2": 10
  };

  // EC 有效系数 = 数据块 / (数据块 + 校验块)
  const ecFactor = {
    "2+1": 2/3,
    "4+1": 4/5,
    "6+1": 6/7,
    "4+2": 4/6,
    "6+2": 6/8,
    "6+3": 6/9,
    "8+2": 8/10
  };

  // DOM
  const nodesSel = document.getElementById("nodes");
  const raidSel = document.getElementById("raid");
  const disksSel = document.getElementById("disks");
  const diskSizeInp = document.getElementById("diskSize");
  const modeSel = document.getElementById("mode");
  const ecSel = document.getElementById("ec");
  const replicaSel = document.getElementById("replica");

  const ecField = document.getElementById("ecField");
  const replicaField = document.getElementById("replicaField");

  const errBox = document.getElementById("errBox");
  const usableTB = document.getElementById("usableTB");
  const detail = document.getElementById("detail");
  const factorsRow = document.getElementById("factorsRow");

  // 初始化节点下拉 3..20
  for (let i = 3; i <= 20; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    nodesSel.appendChild(opt);
  }
  nodesSel.value = "8";

  function raidFactorFn(raid, D) {
    if (raid === "RAID5") return (D - 1) / D;
    if (raid === "RAID6") return (D - 2) / D;
    return 1;
  }

  function pill(text) {
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = text;
    return span;
  }

  function showError(msg) {
    errBox.style.display = "block";
    errBox.textContent = msg;
    usableTB.textContent = "—";
    detail.textContent = "";
  }

  function clearError() {
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function syncModeUI() {
    const mode = modeSel.value;
    if (mode === "replica") {
      ecField.style.display = "none";
      replicaField.style.display = "";
    } else {
      ecField.style.display = "";
      replicaField.style.display = "none";
    }
  }

  function calc() {
    syncModeUI();

    const N = parseInt(nodesSel.value, 10);
    const D = parseInt(disksSel.value, 10);
    const disk = parseFloat(diskSizeInp.value);
    const raid = raidSel.value;
    const mode = modeSel.value; // ec / replica
    const ec = ecSel.value;
    const replica = parseInt(replicaSel.value, 10);

    // 基础校验
    if (!Number.isFinite(disk) || disk <= 0) {
      factorsRow.innerHTML = "";
      showError("❌ 单盘容量必须为大于 0 的数字。");
      return;
    }

    // 计算基础
    const rf = raidFactorFn(raid, D);
    const raw = N * D * disk;

    factorsRow.innerHTML = "";
    factorsRow.appendChild(pill(`RAID系数：${rf.toFixed(4)}`));

    // 副本模式
    if (mode === "replica") {
      clearError();
      factorsRow.appendChild(pill(`副本数：${replica}`));
      const usable = raw * rf / replica;

      usableTB.textContent = `${usable.toFixed(0)} TB`;
      detail.textContent =
        `原始容量 ${raw.toFixed(1)} TB × RAID系数 ${rf.toFixed(4)} ÷ 副本数 ${replica} ≈ ${usable.toFixed(0)} TB`;
      return;
    }

    // EC 模式
    const ef = ecFactor[ec];
    factorsRow.appendChild(pill(`EC系数：${ef.toFixed(4)}`));
    factorsRow.appendChild(pill(`EC最小节点：${ecMinNodes[ec]}`));

    if (N < ecMinNodes[ec]) {
      showError(`❌ 当前节点数量 N=${N}，不足以使用 ${ec}（至少需要 ${ecMinNodes[ec]} 个节点）。`);
      return;
    }

    clearError();
    const usable = raw * rf * ef;

    usableTB.textContent = `${usable.toFixed(0)} TB`;
    detail.textContent =
      `原始容量 ${raw.toFixed(1)} TB × RAID系数 ${rf.toFixed(4)} × EC系数 ${ef.toFixed(4)} ≈ ${usable.toFixed(0)} TB`;
  }

  // 监听
  [nodesSel, raidSel, disksSel, diskSizeInp, modeSel, ecSel, replicaSel].forEach(el => {
    el.addEventListener("input", calc);
    el.addEventListener("change", calc);
  });

  // 初始
  calc();
</script>
</body>
</html>
